# Testing with PostgreSQL - Getting Started

## TL;DR - Quick Start

```bash
# 1. Install PostgreSQL
brew install postgresql@15 && brew services start postgresql@15

# 2. Run setup script
./setup_postgres_test.sh

# 3. Done! Your app now uses PostgreSQL
```

---

## What You Need to Know

### Your app is now **database-flexible**! 

- **No environment variables?** → Uses SQLite (current behavior)
- **Set PostgreSQL variables?** → Uses PostgreSQL
- **Switch anytime!** No code changes needed

### How It Works

```
┌─────────────────────────────────────────────┐
│  Start Django Application                   │
└────────────────┬────────────────────────────┘
                 │
                 ▼
         ┌───────────────┐
         │  Check: Is    │
         │ DATABASE_URL  │
         │    set?       │
         └───┬───────┬───┘
             │       │
         Yes │       │ No
             │       │
             ▼       ▼
    ┌────────────┐ ┌──────────────┐
    │ PostgreSQL │ │ Check: Is    │
    │            │ │ DB_NAME set? │
    └────────────┘ └───┬──────┬───┘
                       │      │
                   Yes │      │ No
                       │      │
                       ▼      ▼
              ┌────────────┐ ┌────────┐
              │ PostgreSQL │ │ SQLite │
              │            │ │        │
              └────────────┘ └────────┘
```

---

## Three Ways to Test PostgreSQL

### Option 1: Automated (Easiest)
```bash
./setup_postgres_test.sh
```
This script does everything for you!

### Option 2: Manual (Full Control)
```bash
# Create database
psql postgres
CREATE USER toyota_user WITH PASSWORD 'mypassword';
CREATE DATABASE toyota_training_test OWNER toyota_user;
\q

# Set environment
export DB_NAME=toyota_training_test
export DB_USER=toyota_user
export DB_PASSWORD=mypassword

# Migrate and run
python manage.py migrate
python manage.py runserver
```

### Option 3: Database URL (Heroku-style)
```bash
export DATABASE_URL="postgres://toyota_user:mypassword@localhost:5432/toyota_training_test"
python manage.py migrate
python manage.py runserver
```

---

## Available Commands

| Command | What It Does |
|---------|--------------|
| `./setup_postgres_test.sh` | Complete automated setup |
| `python test_postgres_connection.py` | Test database connection |
| `python check_postgres_compatibility.py` | Verify code compatibility |
| `python manage.py dbshell` | Open database shell |

---

## Files Created

1. **Guides**
   - `POSTGRESQL_TESTING_GUIDE.md` - Complete documentation
   - `QUICK_START_POSTGRES.md` - Quick reference
   - `POSTGRES_TEST_SUMMARY.md` - Detailed summary
   - `README_POSTGRES.md` - This file

2. **Scripts**
   - `test_postgres_connection.py` - Connection tester
   - `check_postgres_compatibility.py` - Compatibility checker
   - `setup_postgres_test.sh` - Automated setup

3. **Configuration**
   - `.env.postgres` - Generated by setup script (not in git)

4. **Updated Files**
   - `requirements.txt` - Added psycopg2-binary
   - `toyota_training/settings.py` - PostgreSQL support
   - `toyota_training/settings_production.py` - Production config

---

## Compatibility Status ✅

```
✅ Models: Fully compatible
✅ Migrations: All 8 migrations ready
✅ Indexes: Properly configured
✅ Constraints: PostgreSQL-ready
✅ Field Types: No issues
✅ Data Types: Compatible
```

---

## FAQ

**Q: Will this break my current SQLite setup?**  
A: No! SQLite is still the default. PostgreSQL only activates when you set environment variables.

**Q: Can I switch back to SQLite?**  
A: Yes! Just unset the environment variables:
```bash
unset DB_NAME DB_USER DB_PASSWORD DB_HOST DB_PORT DATABASE_URL
```

**Q: Do I need to modify my code?**  
A: No! Everything is handled automatically based on environment variables.

**Q: What about my existing data?**  
A: Export from SQLite, import to PostgreSQL:
```bash
python manage.py dumpdata > data.json
# Switch to PostgreSQL
python manage.py migrate
python manage.py loaddata data.json
```

**Q: How do I know which database I'm using?**  
A: Look for the startup message:
- `✅ Using PostgreSQL database`
- Or run: `python manage.py dbshell`

**Q: Is this production-ready?**  
A: Yes! Includes connection pooling, timeouts, and SSL support.

---

## Environment Variables Reference

### Individual Variables (Recommended for Testing)
```bash
DB_NAME=toyota_training_test      # Database name
DB_USER=toyota_user                # Database user
DB_PASSWORD=your_password          # Database password
DB_HOST=localhost                  # Database host (default: localhost)
DB_PORT=5432                       # Database port (default: 5432)
```

### Single URL (Heroku/Render Style)
```bash
DATABASE_URL=postgres://user:password@host:port/dbname
```

### Not Set
```
(no variables) → Uses SQLite
```

---

## Production Deployment

When deploying to production (Heroku, Render, AWS, etc.):

1. **They provide DATABASE_URL** → Done! Works automatically
2. **They don't provide DATABASE_URL** → Set individual variables
3. **Want to use SQLite in production** → Don't set any variables (not recommended)

---

## Support

**Detailed Help**: See `POSTGRESQL_TESTING_GUIDE.md`

**Quick Reference**: See `QUICK_START_POSTGRES.md`

**Test Connection**: Run `python test_postgres_connection.py`

**Check Compatibility**: Run `python check_postgres_compatibility.py`

---

## Summary

✅ **Your app is PostgreSQL-ready!**

- No code changes required
- Switch databases via environment variables
- Backward compatible with SQLite
- Production-ready configuration
- Comprehensive testing tools included

**Next Step**: Run `./setup_postgres_test.sh` to get started!

---

*Last updated: October 7, 2025*

